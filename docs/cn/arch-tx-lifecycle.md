| id                | title        |
| ----------------- | ------------ |
| arch-tx-lifecycle | 交易生命周期 |

本文档详细说明了Zilliqa网络中交易的生命周期。



# 0. 签名

在发送交易之前，必须先使用有效的私钥对其进行签名。这可以通过Zilliqa团队和社区提供的多种SDK来完成。

签名是针对交易内容的Protobuf序列化版本完成的。这就是为什么所有SDK依赖Protobuf来运行的原因。作为开发人员，此步骤对您而言是无感的。



# 1. 客户 -> 种子

成功签署交易后，您可以广播该交易。这是通过使用种子节点（例如`https://api.zilliqa.com`）完成的。要使用的正确RPC API是`CreateTransaction`。 绑定在所有SDK中都可用。

种子节点会对其接收的JSON有效负载执行一些基本的验证，并将尝试验证签名。请注意，它**不会**验证您的`nonce`的正确性。在任何时候，开发人员都有责任正确增加交易中使用的随机数。

如果使用不正确的`nonce`，则交易不会提示失败。这意味着种子/查找节点将盲目地将您的交易转发到正确的分片，然后分片可以在**没有接收到错误**的情况下拒绝该交易。



# 2. 种子 -> 分片

如果种子节点成功验证了您的交易，则交易将被发送到适当的分片。分片选择取决于[这篇文章](https://blog.zilliqa.com/provisioning-sharding-for-smart-contracts-a-design-for-zilliqa-cd8d012ee735)中详细解释的许多因素。

一旦交易到达分片，可能会发生以下几种情况之一：

1. 交易有效。它包含在微区块中。
2. 交易因重复的现金和/或余额不足而无效，未经处理
3. 交易是一种智能合约调用，会导致错误。该交易将包含在错误`收据`中。
4. 随机数有一个差距。例如：当前现时为1，但是交易现时为3。那么交易将在分片的mempool中保留至后面的DS块为止。



## 案例1和3

一段时间后，分片`领导者`将在包含您的交易的情况下广播建议的区块。你需要消耗gas。



## 案例2

您的交易将被静默删除。因此，建议使用`GetTransaction`对**3** Tx Epochs轮询种子节点。如果交易未得到确认，您可以假设它未包含在任何区块中，应重新进行广播。



## 案例4

在这种情况下，合理方案是重新发送丢失的随机数。例如，如果已经发送了随机数1和3，则应发送具有随机数2的交易，以便处理与随机数3的交易。请注意，mempool仅持续到DS纪元结束。



# 3. 分片 -> DS委员会

经过上述过程，每个分片都会产生一个**微区块**。在DS委员会通过[pBFT共识机制](https://github.com/Zilliqa/dev-portal/blob/master/docs/arch-overview.md#structure-and-consensus)同意阻止交易之后，DS委员会将微区块汇总成交易区块。



# 4. DS委员会 -> 分片 -> 查询/种子

在DS委员会从上面的步骤就交易区块达成共识之后，它将结果广播到所有分片节点和查找节点。如果在此阶段生成了收据，则种子节点将为您的交易生成结果。它将通过RPC API [GetTransaction](https://apidocs.zilliqa.com/#gettransaction)提供。